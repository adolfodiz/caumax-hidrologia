<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Hidrológica CAUMAX Web</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <!-- Folium/Leaflet Draw CSS (for drawing basin) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        #left-panel { width: 35%; padding: 20px; overflow-y: auto; border-right: 1px solid #ccc; box-sizing: border-box; }
        #right-panel { width: 65%; display: flex; flex-direction: column; }
        #map { flex-grow: 1; height: 60%; } /* Map takes 60% of right panel height */
        #results-panel { flex-grow: 1; padding: 20px; overflow-y: auto; border-top: 1px solid #ccc; } /* Results take 40% */
        h1, h2, h3 { color: #333; }
        .input-group { margin-bottom: 10px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .input-group input[type="number"], .input-group input[type="text"] { width: calc(100% - 12px); padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .input-group button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .input-group button:hover { background-color: #0056b3; }
        .checkbox-group label { margin-right: 15px; }
        .section-title { margin-top: 20px; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .result-box { background-color: #f8f9fa; border: 1px solid #e9ecef; padding: 15px; border-radius: 5px; margin-bottom: 10px; }
        .warning-message { color: orange; font-weight: bold; margin-top: 10px; }
        .error-message { color: red; font-weight: bold; margin-top: 10px; }
        #frequency-plot { width: 100%; height: 300px; margin-top: 15px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        table, th, td { border: 1px solid #ddd; }
        th, td { padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <div id="left-panel">
        <h1>Calculadora Hidrológica CAUMAX Web</h1>

        <div class="section-title">Entrada de Datos</div>
        <div class="input-group">
            <button id="select-on-map-btn">Seleccionar en Mapa</button>
        </div>
        <div class="input-group">
            <label for="x-utm">X UTM (ETRS89 Huso 30N):</label>
            <input type="number" id="x-utm" step="0.001">
        </div>
        <div class="input-group">
            <label for="y-utm">Y UTM (ETRS89 Huso 30N):</label>
            <input type="number" id="y-utm" step="0.001">
        </div>
        <div class="input-group">
            <label for="lon-wgs84">Longitud (WGS84):</label>
            <input type="number" id="lon-wgs84" step="0.000001">
        </div>
        <div class="input-group">
            <label for="lat-wgs84">Latitud (WGS84):</label>
            <input type="number" id="lat-wgs84" step="0.000001">
        </div>
        <div class="input-group">
            <label for="return-period">Periodo de Retorno (años):</label>
            <input type="number" id="return-period" value="100" min="2" max="500">
        </div>
        <div class="input-group">
            <button id="calculate-btn">Calcular Caudal</button>
        </div>

        <div class="section-title">Visibilidad de Capas</div>
        <div class="checkbox-group">
            <label><input type="checkbox" id="toggle-demarcaciones" checked> Demarcaciones Hidrográficas</label>
            <label><input type="checkbox" id="toggle-rios" checked> Red Fluvial (10km)</label>
            <label><input type="checkbox" id="toggle-regiones" checked> Regiones Hidrológicas</label>
            <label><input type="checkbox" id="toggle-cuenca" disabled> Cuenca Calculada</label>
            <label><input type="checkbox" id="toggle-point" checked> Punto de Interés</label>
            <label><input type="checkbox" id="toggle-max-dist-point" disabled> Punto Más Alejado</label>
        </div>

        <div class="section-title">Información de la Región</div>
        <div class="result-box">
            <p><strong>Región Seleccionada:</strong> <span id="region-id">N/A</span></p>
            <p><strong>Periodo Retorno MCO (TMCO):</strong> <span id="region-tmco">N/A</span></p>
            <p><strong>Coeficientes P0 por Periodo de Retorno:</strong></p>
            <ul>
                <li>cp0t2: <span id="cp0t2">N/A</span></li>
                <li>cp0t5: <span id="cp0t5">N/A</span></li>
                <li>cp0t10: <span id="cp0t10">N/A</span></li>
                <li>cp0t25: <span id="cp0t25">N/A</span></li>
                <li>cp0t100: <span id="cp0t100">N/A</span></li>
                <li>cp0t500: <span id="cp0t500">N/A</span></li>
            </ul>
            <p><strong>Beta Media de la Región:</strong> <span id="betamedio">N/A</span></p>
            <p><strong>Intervalos de Confianza Beta:</strong></p>
            <ul>
                <li>50%: <span id="ic50">N/A</span></li>
                <li>67%: <span id="ic67">N/A</span></li>
                <li>90%: <span id="ic90">N/A</span></li>
            </ul>
        </div>
    </div>

    <div id="right-panel">
        <div id="map"></div>
        <div id="results-panel">
            <div class="section-title">Resultados del Cálculo</div>
            <p class="warning-message" id="calculation-warning"></p>
            <p class="error-message" id="calculation-error"></p>
            <div class="result-box">
                <p><strong>Periodo de Retorno Solicitado:</strong> <span id="result-rp">N/A</span> años</p>
                <p><strong>Caudal Máximo Estimado:</strong> <span id="result-flow">N/A</span> m³/s</p>
                <p><strong>Caudal Máximo Ordinario (MCO):</strong> <span id="result-mco-flow">N/A</span> m³/s</p>
            </div>

            <div class="section-title">Detalles del Método y Cálculos Intermedios</div>
            <p><strong>Método Aplicado:</strong> <span id="method-applied">N/A</span></p>

            <h3>Tabla de Cuantiles Derivados</h3>
            <table id="derived-quantiles-table">
                <thead>
                    <tr><th>Periodo de Retorno (años)</th><th>Caudal (m³/s)</th></tr>
                </thead>
                <tbody>
                    <!-- Rows will be inserted here by JavaScript -->
                </tbody>
            </table>

            <h3>Ley de Frecuencia</h3>
            <p><strong>Tipo de Función:</strong> <span id="fit-type">N/A</span></p>
            <p><strong>Fórmula:</strong> <img id="fit-formula-img" src="" alt="Fórmula de ajuste" style="max-width: 100%; height: auto;"></p>
            <p><strong>Parámetros de Ajuste:</strong> <span id="fit-params">N/A</span></p>
            <div id="frequency-plot"></div>

            <h3>Variables Intermedias</h3>
            <div class="result-box" id="intermediate-vars-display">
                <!-- Intermediate variables will be displayed here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <!-- Leaflet Draw JS (for drawing basin, though we'll use simple GeoJSON for now) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <!-- Plotly.js for interactive plots -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
        // --- Map Initialization ---
        var map = L.map('map').setView([40.416775, -3.703790], 6); // Centered on Spain

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Google Maps layers (requires API key for production, or use other providers)
        // L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
        //     attribution: 'Google Satellite'
        // }).addTo(map);

        // --- Map Layers (placeholders for now, will load GeoJSON from backend) ---
        var demarcacionesLayer = L.geoJson(null, { style: { color: 'blue', weight: 1, fillOpacity: 0.1 } }).addTo(map);
        var riosLayer = L.geoJson(null, { style: { color: 'cyan', weight: 1.5 } }).addTo(map);
        var regionesLayer = L.geoJson(null, { style: { color: 'purple', weight: 1, fillOpacity: 0.2 } }).addTo(map);
        var basinLayer = L.geoJson(null, { style: { color: 'red', weight: 3, fillOpacity: 0.3 } }).addTo(map);
        var clickMarker = L.marker([0,0]).addTo(map); // Always visible
        var maxDistanceMarker = L.marker([0,0], { icon: L.divIcon({className: 'green-dot', html: '<div style="background-color: green; width: 8px; height: 8px; border-radius: 50%;"></div>'}) }).addTo(map);

        // Hide markers initially
        clickMarker.setOpacity(0);
        maxDistanceMarker.setOpacity(0);

        // --- Event Listeners for Layer Visibility ---
        document.getElementById('toggle-demarcaciones').addEventListener('change', function() {
            if (this.checked) map.addLayer(demarcacionesLayer); else map.removeLayer(demarcacionesLayer);
        });
        document.getElementById('toggle-rios').addEventListener('change', function() {
            if (this.checked) map.addLayer(riosLayer); else map.removeLayer(riosLayer);
        });
        document.getElementById('toggle-regiones').addEventListener('change', function() {
            if (this.checked) map.addLayer(regionesLayer); else map.removeLayer(regionesLayer);
        });
        document.getElementById('toggle-cuenca').addEventListener('change', function() {
            if (this.checked) map.addLayer(basinLayer); else map.removeLayer(basinLayer);
        });
        document.getElementById('toggle-point').addEventListener('change', function() {
            if (this.checked) clickMarker.setOpacity(1); else clickMarker.setOpacity(0);
        });
        document.getElementById('toggle-max-dist-point').addEventListener('change', function() {
            if (this.checked) maxDistanceMarker.setOpacity(1); else maxDistanceMarker.setOpacity(0);
        });

        // --- Coordinate Synchronization Logic ---
        const xUtmInput = document.getElementById('x-utm');
        const yUtmInput = document.getElementById('y-utm');
        const lonWgs84Input = document.getElementById('lon-wgs84');
        const latWgs84Input = document.getElementById('lat-wgs84');

        let isUpdating = false; // Flag to prevent infinite loops during updates

        async function syncCoordinates(sourceInput, crs) {
            if (isUpdating) return;
            isUpdating = true;

            const data = {};
            if (crs === 'WGS84') {
                data.lon = parseFloat(lonWgs84Input.value);
                data.lat = parseFloat(latWgs84Input.value);
            } else if (crs === 'ETRS89_UTM30N') {
                data.x = parseFloat(xUtmInput.value);
                data.y = parseFloat(yUtmInput.value);
            }
            data.input_crs = crs;

            try {
                const response = await fetch('/convert_coords', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();

                if (response.ok) {
                    xUtmInput.value = result.x_utm;
                    yUtmInput.value = result.y_utm;
                    lonWgs84Input.value = result.lon_wgs84;
                    latWgs84Input.value = result.lat_wgs84;

                    // Update map marker
                    clickMarker.setLatLng([result.lat_wgs84, result.lon_wgs84]);
                    clickMarker.setOpacity(1); // Ensure marker is visible
                    document.getElementById('toggle-point').checked = true;
                    map.setView([result.lat_wgs84, result.lon_wgs84], map.getZoom()); // Center map on new point
                } else {
                    console.error("Error converting coordinates:", result.error);
                    // Optionally, clear fields or show an error message
                }
            } catch (error) {
                console.error("Network or server error:", error);
            } finally {
                isUpdating = false;
            }
        }

        xUtmInput.addEventListener('change', () => syncCoordinates(xUtmInput, 'ETRS89_UTM30N'));
        yUtmInput.addEventListener('change', () => syncCoordinates(yUtmInput, 'ETRS89_UTM30N'));
        lonWgs84Input.addEventListener('change', () => syncCoordinates(lonWgs84Input, 'WGS84'));
        latWgs84Input.addEventListener('change', () => syncCoordinates(latWgs84Input, 'WGS84'));

        // --- Map Click Event ---
        map.on('click', function(e) {
            if (document.getElementById('select-on-map-btn').classList.contains('active')) { // Check if map selection mode is active
                isUpdating = true; // Prevent syncCoordinates from triggering multiple times
                lonWgs84Input.value = e.latlng.lng;
                latWgs84Input.value = e.latlng.lat;
                isUpdating = false;
                syncCoordinates(lonWgs84Input, 'WGS84'); // Sync from WGS84
                document.getElementById('select-on-map-btn').classList.remove('active'); // Deactivate mode
            }
        });

        document.getElementById('select-on-map-btn').addEventListener('click', function() {
            this.classList.toggle('active'); // Toggle active class for styling
            alert("Haga clic en el mapa para seleccionar un punto.");
        });

        // --- Load Initial GeoJSON Layers (Example - in a real app, these would come from backend) ---
        // For a real app, you'd have endpoints like /geojson/demarcaciones, /geojson/rios, /geojson/regiones
        // and load them here. For now, they are just placeholders.
        async function loadInitialLayers() {
            // Example: Fetching a dummy GeoJSON
            // const demoDemarcaciones = await fetch('/geojson/demarcaciones').then(res => res.json());
            // demarcacionesLayer.addData(demoDemarcaciones);
            // map.fitBounds(demarcacionesLayer.getBounds()); // Fit map to data

            // Placeholder for actual GeoJSON loading
            // For now, just ensure checkboxes reflect initial state
            if (!document.getElementById('toggle-demarcaciones').checked) map.removeLayer(demarcacionesLayer);
            if (!document.getElementById('toggle-rios').checked) map.removeLayer(riosLayer);
            if (!document.getElementById('toggle-regiones').checked) map.removeLayer(regionesLayer);
        }
        loadInitialLayers();


        // --- Calculation Logic ---
        document.getElementById('calculate-btn').addEventListener('click', async function() {
            const x_utm = parseFloat(xUtmInput.value);
            const y_utm = parseFloat(yUtmInput.value);
            const return_period = parseFloat(document.getElementById('return-period').value);

            // Clear previous results and errors
            document.getElementById('calculation-warning').textContent = '';
            document.getElementById('calculation-error').textContent = '';
            document.getElementById('result-rp').textContent = 'N/A';
            document.getElementById('result-flow').textContent = 'N/A';
            document.getElementById('result-mco-flow').textContent = 'N/A';
            document.getElementById('method-applied').textContent = 'N/A';
            document.getElementById('fit-type').textContent = 'N/A';
            document.getElementById('fit-formula-img').src = '';
            document.getElementById('fit-params').textContent = 'N/A';
            document.getElementById('derived-quantiles-table').getElementsByTagName('tbody')[0].innerHTML = '';
            document.getElementById('intermediate-vars-display').innerHTML = '';
            Plotly.purge('frequency-plot'); // Clear previous plot

            // Disable buttons during calculation
            this.disabled = true;
            document.getElementById('select-on-map-btn').disabled = true;

            try {
                const response = await fetch('/calculate_hydrology', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ x_utm, y_utm, return_period })
                });
                const result = await response.json();

                if (response.ok) {
                    // Display main results
                    document.getElementById('result-rp').textContent = return_period;
                    document.getElementById('result-flow').textContent = result.flow_user_rp;
                    document.getElementById('result-mco-flow').textContent = result.flow_tmco;
                    document.getElementById('method-applied').textContent = result.method_used;

                    // Display warnings
                    if (result.warnings && result.warnings.length > 0) {
                        document.getElementById('calculation-warning').textContent = result.warnings.join('\n');
                    }

                    // Display region info
                    document.getElementById('region-id').textContent = result.region_info.id;
                    document.getElementById('region-tmco').textContent = result.region_info.tmco;
                    document.getElementById('cp0t2').textContent = result.region_info.cp0t2;
                    document.getElementById('cp0t5').textContent = result.region_info.cp0t5;
                    document.getElementById('cp0t10').textContent = result.region_info.cp0t10;
                    document.getElementById('cp0t25').textContent = result.region_info.cp0t25;
                    document.getElementById('cp0t100').textContent = result.region_info.cp0t100;
                    document.getElementById('cp0t500').textContent = result.region_info.cp0t500;
                    document.getElementById('betamedio').textContent = result.region_info.betamedio;
                    document.getElementById('ic50').textContent = result.region_info.ic50;
                    document.getElementById('ic67').textContent = result.region_info.ic67;
                    document.getElementById('ic90').textContent = result.region_info.ic90;


                    // Display derived quantiles table
                    const tableBody = document.getElementById('derived-quantiles-table').getElementsByTagName('tbody')[0];
                    result.derived_quantiles_table.forEach(item => {
                        const row = tableBody.insertRow();
                        row.insertCell().textContent = item.period;
                        row.insertCell().textContent = item.flow;
                    });

                    // Display fit info and plot
                    if (result.fit_info) {
                        document.getElementById('fit-type').textContent = result.fit_info.type;
                        // Assuming formula_svg is a path to an SVG image served by Flask static files
                        document.getElementById('fit-formula-img').src = `/static/formulas/${result.fit_info.formula_svg}`;
                        let paramsText = '';
                        for (const key in result.fit_info.params) {
                            paramsText += `${key}: ${result.fit_info.params[key]}<br>`;
                        }
                        document.getElementById('fit-params').innerHTML = paramsText;

                        // Plotly plot
                        const plotDiv = document.getElementById('frequency-plot');
                        const plotData = result.plot_data;

                        const traceCurve = {
                            x: plotData.all_periods_for_curve,
                            y: plotData.all_flows_for_curve,
                            mode: 'lines',
                            name: 'Curva de Ajuste',
                            line: { color: 'blue' }
                        };
                        const tracePoints = {
                            x: plotData.periods,
                            y: plotData.flows,
                            mode: 'markers',
                            name: 'Puntos de Ajuste',
                            marker: { color: 'red', size: 8 }
                        };
                        const traceUserPoint = {
                            x: [plotData.user_period_plot_val],
                            y: [plotData.user_flow_plot_val],
                            mode: 'markers',
                            name: `T=${return_period} años`,
                            marker: { color: 'green', size: 10, symbol: 'circle' }
                        };
                        const traceMCOPoint = {
                            x: [plotData.tmco_period_plot_val],
                            y: [plotData.tmco_flow_plot_val],
                            mode: 'markers',
                            name: `TMCO=${result.region_info.tmco} años`,
                            marker: { color: 'purple', size: 10, symbol: 'star' }
                        };

                        const layout = {
                            title: 'Gráfico Ley de Frecuencia',
                            xaxis: {
                                title: 'Periodo de retorno (años)',
                                tickvals: [plotData.periods[0], plotData.periods[1], plotData.periods[2], plotData.periods[3], plotData.periods[4], plotData.periods[5]],
                                ticktext: ['2', '5', '10', '25', '100', '500'],
                                type: 'linear', // Use 'log' if you want log scale on x-axis
                                showgrid: true
                            },
                            yaxis: {
                                title: 'Caudal (m³/s)',
                                showgrid: true
                            },
                            hovermode: 'closest'
                        };
                        Plotly.newPlot(plotDiv, [traceCurve, tracePoints, traceUserPoint, traceMCOPoint], layout);
                    }

                    # Display intermediate variables
                    const intermediateVarsHtml = Object.entries(result.intermediate_variables).map(([key, value]) => `<p><strong>${key.replace(/_/g, ' ')}:</strong> ${value}</p>`).join('');
                    document.getElementById('intermediate-vars-display').innerHTML = intermediateVarsHtml;

                    # Update map layers
                    if (result.basin_properties && result.basin_properties.basin_geojson) {
                        basinLayer.clearLayers();
                        basinLayer.addData(JSON.parse(result.basin_properties.basin_geojson));
                        document.getElementById('toggle-cuenca').checked = true;
                        map.addLayer(basinLayer);
                        # Fit map to basin bounds
                        if (basinLayer.getBounds().isValid()) {
                            map.fitBounds(basinLayer.getBounds().pad(0.1)); # Add some padding
                        }
                    }

                    if (result.basin_properties && result.basin_properties.x_max_distance && result.basin_properties.y_max_distance) {
                        const [lon_max_dist, lat_max_dist] = await (await fetch('/convert_coords', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ x: result.basin_properties.x_max_distance, y: result.basin_properties.y_max_distance, input_crs: 'ETRS89_UTM30N' })
                        })).json().then(data => [data.lon_wgs84, data.lat_wgs84]);
                        maxDistanceMarker.setLatLng([lat_max_dist, lon_max_dist]);
                        maxDistanceMarker.setOpacity(1);
                        document.getElementById('toggle-max-dist-point').checked = true;
                    } else {
                        maxDistanceMarker.setOpacity(0);
                        document.getElementById('toggle-max-dist-point').checked = false;
                    }

                } else {
                    document.getElementById('calculation-error').textContent = result.error || "Error desconocido en el cálculo.";
                }
            } catch (error) {
                console.error("Error en la solicitud de cálculo:", error);
                document.getElementById('calculation-error').textContent = "Error de conexión o del servidor: " + error.message;
            } finally {
                # Re-enable buttons
                this.disabled = false;
                document.getElementById('select-on-map-btn').disabled = false;
            }
        });

        # --- Initial Layer Loading (Placeholder for actual GeoJSON data) ---
        # In a real application, you would fetch these GeoJSONs from your Flask backend
        # e.g., fetch('/geojson/demarcaciones').then(response => response.json()).then(data => demarcacionesLayer.addData(data));
        # For this example, we'll just ensure the checkboxes control the visibility of empty layers.
        if (!document.getElementById('toggle-demarcaciones').checked) demarcacionesLayer.remove();
        if (!document.getElementById('toggle-rios').checked) riosLayer.remove();
        if (!document.getElementById('toggle-regiones').checked) regionesLayer.remove();
        document.getElementById('toggle-cuenca').checked = false; basinLayer.remove();
        document.getElementById('toggle-point').checked = false; clickMarker.remove();
        document.getElementById('toggle-max-dist-point').checked = false; maxDistanceMarker.remove();

    </script>
</body>
</html>